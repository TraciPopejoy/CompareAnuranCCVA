---
title: "Use SDMs to measure CCV"
author: "Chloe Moore & TP DuBose"
date: "1/10/2023"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#library(dismo)
library(raster); library(terra); library(stars)
library(landscapemetrics)
```

```{r cars}
PATH_sdms<-'data/SDMs/'
PATH_spatext<-'b_RegionalRCS/spatial_extent.rds'
prism.ppt<-''
prism.Tmax<-''
prism.Tmin<-''
# to do :
# replace fake data
# need to project the raster to albers projection 
# more research on ways to estimate vulnerability from SDMs

crs.sdms<-"+proj=longlat +datum=WGS84 +no_defs" # crs of sdms
crs.albers <- st_crs("+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=37.5 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=km +no_defs")
# clip rasters to our study area
se <- readRDS(PATH_spatext) %>% st_as_sf() %>%
  st_transform(crs.albers)
#st_crs(se)

# create raster of study extent
se_r<-st_rasterize(se, dx=100, dy=100) %>% #turn into a raster of 1x1 kilometers
  st_as_sf(as_points = FALSE, merge = FALSE) %>%  #turn into a polygon
  rowid_to_column() # add an id column
st_area(se_r[1,])
cat('raster created\n')
spat.ext.terra<-rast(se_r) 

# faking some data
se_ppt<-spat.ext.terra
values(se_ppt)<-runif(ncell(se_ppt), min=500, max=800)
se_ppt<-project(se_ppt, d.bin, mask=T)    
se_tmx<-spat.ext.terra
values(se_tmx)<-runif(ncell(se_tmx), min=16, max=30)
se_tmx<-project(se_tmx, d.bin, mask=T)
se_tmn<-spat.ext.terra
values(se_tmn)<-runif(ncell(se_tmn), min=-5, max=5)

stats_out<-NULL
for(spp in c('Anaxyrus_terrestris','Scaphiopus_holbrookii','Dryophytes_squirellus', 
             'Lithobates_virgatipes', 'Lithobates_sphenocephalus')){
 # read in the outputs from the SDMs
  sp_files<-list.files(PATH_sdms, pattern=spp, full.names=T)
  print(sp_files[grepl('_bi_pred.asc', sp_files)])
  d.bin<-rast(sp_files[grepl('_bi_pred.asc',sp_files)])
  d.bin[d.bin==0] <- NA
  clim_out<-NULL
for(env.r in c('se_ppt','se_tmx','se_tmn')){
  env.ras<-get(env.r)
  env.ras<-project(env.ras, d.bin, mask=T)
  env.var<-d.bin*env.ras
  clim_out<-bind_rows(clim_out,
            bind_cols(global(env.var, 'mean', na.rm=T),
                      global(env.var, 'sd', na.rm=T)) %>%
              mutate(clim=env.r))}
  # landscape metrics on the binary raster
spp_out<-bind_rows(
  lsm_l_ta(d.bin), # total area in hectares
          lsm_l_cohesion(d.bin), # patch cohesion
          lsm_l_area_mn(d.bin), # mean area of patch
          # used in Hoecker & Turner et al. 2022
          lsm_l_enn_mn(d.bin), # connectedness
          lsm_l_para_mn(d.bin), # shape, perimieter:area
          # used in Rose et al. 2022
          lsm_p_area(d.bin) %>% # number of patches
            group_by(layer, level, class, metric) %>%
            summarize(value=n(), .groups = 'drop'), 
          lsm_l_enn_cv(d.binc)) %>% # patch isolation
  select(-layer, -id) %>%
  bind_rows(# realized climate niche breadth
    clim_out %>% as_tibble() %>% pivot_longer(-clim) %>%
      mutate(metric=paste(clim, name, sep='.')) %>%
      select(-name, clim)) %>%
  mutate(species = gsub('_',' ',spp)) # add in species
stats_out <- bind_rows(stats_out, spp_out)
  # extrapolate to projected climate
  #sdmout<-readRDS('C:/Users/Owner/Downloads/Scaphiopus_holbrookii_topmodel.rds')
}
check_landscape(d.bin)
stats_out
write.csv(stats_out, 'results/analyzed_sdm_metrics.csv', row.names = F)
```
